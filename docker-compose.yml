version: '3.8'

services:
  # PostgreSQL Database
    postgres:
        image: postgres:15-alpine
            container_name: content-intelligence-postgres
                environment:
                      POSTGRES_USER: ${DB_USER:-postgres}
                            POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
                                  POSTGRES_DB: ${DB_NAME:-content_intelligence}
                                      ports:
                                            - "5432:5432"
                                                volumes:
                                                      - postgres_data:/var/lib/postgresql/data
                                                          networks:
                                                                - content-network
                                                                    healthcheck:
                                                                          test: ["CMD-SHELL", "pg_isready -U postgres"]
                                                                                interval: 10s
                                                                                      timeout: 5s
                                                                                            retries: 5

                                                                                              # Redis Cache & Task Queue
                                                                                                redis:
                                                                                                    image: redis:7-alpine
                                                                                                        container_name: content-intelligence-redis
                                                                                                            ports:
                                                                                                                  - "6379:6379"
                                                                                                                      volumes:
                                                                                                                            - redis_data:/data
                                                                                                                                networks:
                                                                                                                                      - content-network
                                                                                                                                          healthcheck:
                                                                                                                                                test: ["CMD", "redis-cli", "ping"]
                                                                                                                                                      interval: 10s
                                                                                                                                                            timeout: 5s
                                                                                                                                                                  retries: 5
                                                                                                                                                                  
                                                                                                                                                                    # FastAPI Backend
                                                                                                                                                                      backend:
                                                                                                                                                                          build:
                                                                                                                                                                                context: ./backend
                                                                                                                                                                                      dockerfile: Dockerfile
                                                                                                                                                                                          container_name: content-intelligence-backend
                                                                                                                                                                                              command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
                                                                                                                                                                                                  ports:
                                                                                                                                                                                                        - "8000:8000"
                                                                                                                                                                                                            environment:
                                                                                                                                                                                                                  DATABASE_URL: postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-postgres}@postgres:5432/${DB_NAME:-content_intelligence}
                                                                                                                                                                                                                        REDIS_URL: redis://redis:6379/0
                                                                                                                                                                                                                              OPENAI_API_KEY: ${OPENAI_API_KEY}
                                                                                                                                                                                                                                    ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
                                                                                                                                                                                                                                          APIFY_API_KEY: ${APIFY_API_KEY}
                                                                                                                                                                                                                                                SECRET_KEY: ${SECRET_KEY:-your-secret-key-change-in-production}
                                                                                                                                                                                                                                                      TRANSCRIPTION_SERVICE: ${TRANSCRIPTION_SERVICE:-whisper_api}
                                                                                                                                                                                                                                                          volumes:
                                                                                                                                                                                                                                                                - ./backend:/app
                                                                                                                                                                                                                                                                      - uploads:/app/uploads
                                                                                                                                                                                                                                                                          depends_on:
                                                                                                                                                                                                                                                                                postgres:
                                                                                                                                                                                                                                                                                        condition: service_healthy
                                                                                                                                                                                                                                                                                              redis:
                                                                                                                                                                                                                                                                                                      condition: service_healthy
                                                                                                                                                                                                                                                                                                          networks:
                                                                                                                                                                                                                                                                                                                - content-network
                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                  # Celery Worker
                                                                                                                                                                                                                                                                                                                    celery_worker:
                                                                                                                                                                                                                                                                                                                        build:
                                                                                                                                                                                                                                                                                                                              context: ./backend
                                                                                                                                                                                                                                                                                                                                    dockerfile: Dockerfile
                                                                                                                                                                                                                                                                                                                                        container_name: content-intelligence-celery
                                                                                                                                                                                                                                                                                                                                            command: celery -A app.tasks.celery_tasks worker --loglevel=info
                                                                                                                                                                                                                                                                                                                                                environment:
                                                                                                                                                                                                                                                                                                                                                      DATABASE_URL: postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-postgres}@postgres:5432/${DB_NAME:-content_intelligence}
                                                                                                                                                                                                                                                                                                                                                            REDIS_URL: redis://redis:6379/0
                                                                                                                                                                                                                                                                                                                                                                  OPENAI_API_KEY: ${OPENAI_API_KEY}
                                                                                                                                                                                                                                                                                                                                                                        ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
                                                                                                                                                                                                                                                                                                                                                                              APIFY_API_KEY: ${APIFY_API_KEY}
                                                                                                                                                                                                                                                                                                                                                                                    SECRET_KEY: ${SECRET_KEY:-your-secret-key-change-in-production}
                                                                                                                                                                                                                                                                                                                                                                                          TRANSCRIPTION_SERVICE: ${TRANSCRIPTION_SERVICE:-whisper_api}
                                                                                                                                                                                                                                                                                                                                                                                              volumes:
                                                                                                                                                                                                                                                                                                                                                                                                    - ./backend:/app
                                                                                                                                                                                                                                                                                                                                                                                                          - uploads:/app/uploads
                                                                                                                                                                                                                                                                                                                                                                                                              depends_on:
                                                                                                                                                                                                                                                                                                                                                                                                                    - redis
                                                                                                                                                                                                                                                                                                                                                                                                                          - postgres
                                                                                                                                                                                                                                                                                                                                                                                                                              networks:
                                                                                                                                                                                                                                                                                                                                                                                                                                    - content-network
                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                      # Next.js Frontend
                                                                                                                                                                                                                                                                                                                                                                                                                                        frontend:
                                                                                                                                                                                                                                                                                                                                                                                                                                            build:
                                                                                                                                                                                                                                                                                                                                                                                                                                                  context: ./frontend
                                                                                                                                                                                                                                                                                                                                                                                                                                                        dockerfile: Dockerfile
                                                                                                                                                                                                                                                                                                                                                                                                                                                            container_name: content-intelligence-frontend
                                                                                                                                                                                                                                                                                                                                                                                                                                                                ports:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      - "3000:3000"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          environment:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8000}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    volumes:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          - ./frontend:/app
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - /app/.next
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    depends_on:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          - backend
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              networks:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    - content-network
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    networks:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      content-network:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          driver: bridge
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          volumes:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            postgres_data:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              redis_data:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                uploads:
